



<!doctype html>
<html lang="zh-Hant" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="複製">
      
        <meta name="lang:clipboard.copied" content="已複製">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="沒有符合的項目">
      
        <meta name="lang:search.result.one" content="找到 1 個符合的項目">
      
        <meta name="lang:search.result.other" content="找到 # 個符合的項目">
      
        <meta name="lang:search.tokenizer" content="[a-z0-9\-\s\.]+">
      
      <link rel="shortcut icon" href="../img/doc-icon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.0">
    
    
      
        <title>IoT Server APIs - ZIOT Design</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="red" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#iot-server-apis" tabindex="1" class="md-skip">
        跳轉到
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="ZIOT Design" class="md-header-nav__button md-logo">
          
            <img src="../img/doc-icon.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              ZIOT Design
            </span>
            <span class="md-header-nav__topic">
              
                IoT Server APIs
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            打字進行搜尋
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." class="md-tabs__link md-tabs__link--active">
        概觀
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../basebox/" class="md-tabs__link">
          基盒
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../toolz/" class="md-tabs__link">
          Toolz
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../dummy.md" class="md-tabs__link">
          Web UI
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../api-overview/" class="md-tabs__link">
          API
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../documentation/" class="md-tabs__link">
          Other Resources
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="ZIOT Design" class="md-nav__button md-logo">
      
        <img src="../img/doc-icon.png" width="48" height="48">
      
    </a>
    ZIOT Design
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="概觀" class="md-nav__link">
      概觀
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      基盒
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        基盒
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../basebox/" title="什麼是基盒" class="md-nav__link">
      什麼是基盒
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bb-machines-supported/" title="支援的機器" class="md-nav__link">
      支援的機器
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bb-machines-supported/" title="如何註冊基盒" class="md-nav__link">
      如何註冊基盒
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Toolz
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Toolz
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz/" title="什麼是 Toolz" class="md-nav__link">
      什麼是 Toolz
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz-get-started/" title="開始使用 Toolz" class="md-nav__link">
      開始使用 Toolz
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz-config/" title="配置 Toolz" class="md-nav__link">
      配置 Toolz
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      快速使用指南
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        快速使用指南
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz-quick-wifi-setting/" title="設定 WiFi" class="md-nav__link">
      設定 WiFi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz-quick-wifi-installer/" title="自定義的 WiFi 安裝包" class="md-nav__link">
      自定義的 WiFi 安裝包
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../toolz-update/" title="更新 tool.exe" class="md-nav__link">
      更新 tool.exe
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-5" type="checkbox" id="nav-3-5">
    
    <label class="md-nav__link" for="nav-3-5">
      Basebox 相關參考
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-5">
        Basebox 相關參考
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../bb-auto-mode/" title="自動執行模式" class="md-nav__link">
      自動執行模式
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Web UI
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Web UI
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dummy.md" title="Help" class="md-nav__link">
      Help
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api-overview/" title="API Overview" class="md-nav__link">
      API Overview
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Other Resources
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Other Resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../documentation/" title="Documentation" class="md-nav__link">
      Documentation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../guide/" title="Guide" class="md-nav__link">
      Guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../linux-tips/" title="Linux Tips" class="md-nav__link">
      Linux Tips
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../app-server-checklist/" title="ZIOT Server Checklist" class="md-nav__link">
      ZIOT Server Checklist
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">本頁目錄</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#databases" class="md-nav__link">
    Databases
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#naming-convention" class="md-nav__link">
    Naming Convention
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#admindb" class="md-nav__link">
    admin.db
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logins" class="md-nav__link">
    logins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orgs" class="md-nav__link">
    orgs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orgs_logins" class="md-nav__link">
    orgs_logins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restrictions" class="md-nav__link">
    restrictions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datadb" class="md-nav__link">
    data.db
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#table-devices" class="md-nav__link">
    table devices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-handlers" class="md-nav__link">
    table handlers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-hello" class="md-nav__link">
    table hello
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-machines" class="md-nav__link">
    table machines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-operations" class="md-nav__link">
    table operations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-measures" class="md-nav__link">
    table measures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-shifts" class="md-nav__link">
    table shifts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-units_headers" class="md-nav__link">
    table units_headers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#table-units" class="md-nav__link">
    table units
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#view-v_current_shifts" class="md-nav__link">
    view v_current_shifts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interfaces" class="md-nav__link">
    Interfaces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#di" class="md-nav__link">
    DI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#di-details" class="md-nav__link">
    DI Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reset-password" class="md-nav__link">
    reset-password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-on" class="md-nav__link">
    sign-on
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-in" class="md-nav__link">
    sign-in
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify-reset-password" class="md-nav__link">
    verify-reset-password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#me" class="md-nav__link">
    me
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-off" class="md-nav__link">
    sign-off
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#orgs_1" class="md-nav__link">
    orgs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clear-org-key" class="md-nav__link">
    clear-org-key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new-org-key" class="md-nav__link">
    new-org-key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#devices" class="md-nav__link">
    devices
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logins_1" class="md-nav__link">
    logins
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#machines" class="md-nav__link">
    machines
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shifts" class="md-nav__link">
    shifts
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#di-legacy-paths" class="md-nav__link">
    DI Legacy Paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi-legacy-paths" class="md-nav__link">
    MI Legacy Paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi" class="md-nav__link">
    MI
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi-json" class="md-nav__link">
    MI JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mi-details" class="md-nav__link">
    MI Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#http-vs-ws" class="md-nav__link">
    HTTP vs WS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#auth" class="md-nav__link">
    auth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#counter" class="md-nav__link">
    counter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hello" class="md-nav__link">
    hello
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#measure" class="md-nav__link">
    measure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resend" class="md-nav__link">
    resend
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-broadcast" class="md-nav__link">
    time broadcast
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-request" class="md-nav__link">
    time request
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#corebus" class="md-nav__link">
    CoreBus
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bus-event-naming" class="md-nav__link">
    Bus Event Naming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-following-is-going-to-be-redesigned" class="md-nav__link">
    The following is going to be redesigned.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-operations" class="md-nav__link">
    General Operations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-start-up" class="md-nav__link">
    Device start up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-of-the-database" class="md-nav__link">
    Indexing of the database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#miot" class="md-nav__link">
    mIoT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bugs-todo" class="md-nav__link">
    Bugs &amp; Todo
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="iot-server-apis">IoT Server APIs</h1>
<p>This document is to describe the design of iot server version 2. This is a big change to the whole design from database to interface (API).</p>
<h2 id="databases">Databases</h2>
<p>Version 2 design introduce the following databases changes:</p>
<ol>
<li>New admin.db to maintain the organization and logins information.</li>
<li>Support more than one data.db (the old name is test.db).</li>
<li>Redesign of the table schema.</li>
</ol>
<h2 id="naming-convention">Naming Convention</h2>
<ol>
<li>Table name is in norn plural form.</li>
<li>Table name is in lower case and separated by underscore <code class="codehilite"><span class="n">_</span></code>.</li>
<li>Field <code class="codehilite"><span class="n">_id</span></code> in a table is the unique identity key of the record in the table.</li>
<li>Field <code class="codehilite"><span class="n">cwho</span></code> in a table is the id of creation login of the record.</li>
<li>Field <code class="codehilite"><span class="n">cts</span></code> in a table is the timestamp (<code class="codehilite"><span class="n">js</span></code>) of creation of the record.</li>
<li>Field <code class="codehilite"><span class="n">who</span></code> in a table is the id of modification login of creation of the record.</li>
<li>Field <code class="codehilite"><span class="n">ts</span></code> in a table is the timestamp (<code class="codehilite"><span class="n">js</span></code>) of modification of the record.</li>
<li>Field <code class="codehilite"><span class="n">sdate</span></code> in a table is the shift date (班次日期) of the record.</li>
<li>If a field name is the same as a table name <code class="codehilite"><span class="n">x</span></code>, it is referencing to the <code class="codehilite"><span class="n">_id</span></code> of the table of <code class="codehilite"><span class="n">x</span></code>.</li>
</ol>
<h2 id="admindb">admin.db</h2>
<h3 id="logins">logins</h3>
<blockquote>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id</td>
<td>The internal id of the login record</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td>The type of login</td>
<td><code class="codehilite"><span class="n">super</span></code></td>
</tr>
<tr>
<td>uid</td>
<td>The user id or account code of the login</td>
<td></td>
</tr>
<tr>
<td>pwd</td>
<td>The encrypted user password</td>
<td></td>
</tr>
<tr>
<td>pwds</td>
<td>Internal use</td>
<td></td>
</tr>
<tr>
<td>salt</td>
<td>The salt of the user</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td>The natural name of user</td>
<td></td>
</tr>
<tr>
<td>email</td>
<td>The email of the user</td>
<td></td>
</tr>
<tr>
<td>mobile</td>
<td>The mobile of the user</td>
<td></td>
</tr>
<tr>
<td>tz</td>
<td>The default timezone of the user.</td>
<td>Default is 8.</td>
</tr>
<tr>
<td>ts</td>
<td>The ts of the creation/change of the record</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>The status of the user</td>
<td><code class="codehilite"><span class="n">newly</span><span class="o">-</span><span class="n">created</span></code>, <code class="codehilite"><span class="cp">..</span></code></td>
</tr>
<tr>
<td>reset_pwd_token</td>
<td>The token of reset password request</td>
<td></td>
</tr>
<tr>
<td>reset_pwd_ts</td>
<td>The ts of reset password token</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="orgs">orgs</h3>
<blockquote>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id</td>
<td>The internal id of the org record</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td>The name of the org</td>
<td></td>
</tr>
<tr>
<td>sn</td>
<td>The short name of the org</td>
<td></td>
</tr>
<tr>
<td>tz</td>
<td>The timezone of org. It's default value is the tz of owner</td>
<td></td>
</tr>
<tr>
<td>owner</td>
<td>The owner of the org.</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>type</td>
<td>The type of the org.</td>
<td><code class="codehilite"><span class="n">personal</span></code>, <code class="codehilite"><span class="n">basic</span></code></td>
</tr>
<tr>
<td>status</td>
<td>The status of the org.</td>
<td><code class="codehilite"><span class="n">newly</span><span class="o">-</span><span class="n">created</span></code>,<code class="codehilite"><span class="n">removed</span></code></td>
</tr>
<tr>
<td>dataStore</td>
<td>The name of the data store</td>
<td>system internal assigned</td>
</tr>
<tr>
<td>orgKey</td>
<td>The orgKey of the org</td>
<td></td>
</tr>
<tr>
<td>orgKeyTs</td>
<td>The ts of the generation/change of orgKey</td>
<td></td>
</tr>
<tr>
<td>ts</td>
<td>the ts of the change of the record</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="orgs_logins">orgs_logins</h3>
<blockquote>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id</td>
<td>The internal id of this record</td>
<td></td>
</tr>
<tr>
<td>orgs</td>
<td>The id of the orgs</td>
<td>ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>logins</td>
<td>The id of the logins</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>roles</td>
<td>The role of the login in the org</td>
<td><code class="codehilite"><span class="k">owner</span></code>, <code class="codehilite"><span class="n">viewer</span></code></td>
</tr>
<tr>
<td>who</td>
<td>The id of the user who create/change this record</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>status</td>
<td>The status of this relationship</td>
<td><code class="codehilite"><span class="n">enable</span></code>,<code class="codehilite"><span class="n">disabled</span></code></td>
</tr>
<tr>
<td>ts</td>
<td>The ts of the record</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="restrictions">restrictions</h3>
<blockquote>
<table>
<thead>
<tr>
<th>field</th>
<th>description</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id</td>
<td>The internal id of this record</td>
<td></td>
</tr>
<tr>
<td>orgs</td>
<td>The id of the orgs</td>
<td>ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>logins</td>
<td>The id of the logins</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>role</td>
<td>The role of the login have any restriction</td>
<td></td>
</tr>
<tr>
<td>rules</td>
<td>A JSON data to control what data should be be restricted.</td>
<td></td>
</tr>
<tr>
<td>who</td>
<td>The id of the user who create/change this record</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>ts</td>
<td>The ts of the record</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h2 id="datadb">data.db</h2>
<h3 id="table-devices">table devices</h3>
<blockquote>
<table>
<thead>
<tr>
<th>new</th>
<th>old</th>
<th>description</th>
<th>change remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>_id</td>
<td>ID</td>
<td>The internal id of the device record</td>
<td>Type change to CHAR.</td>
</tr>
<tr>
<td>orgs</td>
<td></td>
<td>The id of org the device belongs to</td>
<td>ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>physical_id</td>
<td>device_id</td>
<td>The chip id (nodemcu) or physical device id.</td>
<td>It is read from device</td>
</tr>
<tr>
<td>usage</td>
<td>usage</td>
<td>The usage description of the device</td>
<td></td>
</tr>
<tr>
<td>token</td>
<td></td>
<td>The device token</td>
<td></td>
</tr>
<tr>
<td>tokenTs</td>
<td></td>
<td>The timestamp of the creation of device token</td>
<td></td>
</tr>
<tr>
<td>type</td>
<td></td>
<td>Type of the device</td>
<td><code class="codehilite"><span class="n">virtual</span><span class="o">-</span><span class="n">device</span></code></td>
</tr>
<tr>
<td>status</td>
<td></td>
<td>Status of the device</td>
<td><code class="codehilite"><span class="n">enabled</span></code> , <code class="codehilite"><span class="n">disabled</span></code></td>
</tr>
<tr>
<td>description</td>
<td></td>
<td>The description of the device</td>
<td></td>
</tr>
<tr>
<td>max_machine</td>
<td>max_machine</td>
<td>The max number of machine can be assigned to the device.</td>
<td></td>
</tr>
<tr>
<td>who</td>
<td></td>
<td>The id of user who create/change this record</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td>ts</td>
<td></td>
<td>The ts of the record</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="table-handlers">table handlers</h3>
<p><em>Since 2019-09-06</em></p>
<p>This is to define the <em>event data handler</em>.</p>
<blockquote>
<table>
<thead>
<tr>
<th>new</th>
<th>old</th>
<th>description</th>
<th>change remark</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="n">orgs</span></code></td>
<td></td>
<td>The id of org the handler belongs to</td>
<td>ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">_id</span></code></td>
<td></td>
<td>The internal id of the handler record</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">code</span></code></td>
<td></td>
<td>The code of the handler. <code class="codehilite"><span class="n">code</span></code> = <code class="codehilite"><span class="n">counter</span></code> is reserved.</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">name</span></code></td>
<td></td>
<td>The name of the handler.</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">process_type</span></code></td>
<td></td>
<td>The process type the handler. Process Type let system know how to process (logic) the <em>event data</em> received. <code class="codehilite"><span class="n">counter</span></code>,<code class="codehilite"><span class="k">on</span></code>,<code class="codehilite"><span class="k">off</span></code> are its valid value.</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">remark</span></code></td>
<td></td>
<td>Any user remarks.</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">who</span></code></td>
<td></td>
<td>The id of login who change the record</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">ts</span></code></td>
<td></td>
<td>The ts of the record changed</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">cwho</span></code></td>
<td></td>
<td>The id of login who create the record</td>
<td>ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">cts</span></code></td>
<td></td>
<td>The ts of the record created</td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>
<h3 id="table-hello">table hello</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|orgs| | The id of org the device belongs to | ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code> |
|server_ts|server_ts|The server ts of the record|
|devices |device_id | The device internal id| Type change to CHAR.|
|op_ip|op_id| The ip of the device |
|op_ts|op_ts| The ts of the hello message | Unix epoch |
|message|message| The hello message(information) containing the device id, circuit type, start reason etc.|
|machines| machine_id| The internal id of the machine the device is assigned.| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">_id</span></code>|</p>
</blockquote>
<h3 id="table-machines">table machines</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|orgs| | The id of org the machine belongs to | ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code> |
|_id| ID | The internal id of the machine record | Type change to CHAR|
|code| code| The code of the machine for daily usage or reference to its id in other system.
|name| name| The name of tha machine|
|type | type| The type of the machine|
|class| class| The class of the machine. A class is a group of machines.|
|spec| spec| The spec description of the machine.|
|status|status| The current scheduled (planned) status of the machine|<code class="codehilite"><span class="n">schedule_on</span></code>, <code class="codehilite"><span class="n">schedule_off</span></code>, <code class="codehilite"><span class="n">schedule_maint</span></code>,<code class="codehilite"><span class="n">disabled</span></code>|
|location|location | The location description where the machine is located. It can be a Map name. |
|bound| | The bound data (x,y,w,h) of the machine in a map if the <code class="codehilite"><span class="k">location</span></code> is a map name. |
|cum_count|cum_count| The cumulative count of the machine |
|wo|wo| The current work order (production order, mo etc) the machine is working for.| This is a work status info|
|product|product| The current product (part etc) the machine is working for.| This is a work status info|
|mold|mold| The mold (or assistant tools) the machine is equipped. | This is a work status info|
|target| target |The current target of cycle time of the machine| This is a work status info|
|who|  | The id of login who change the record | ref to <code class="codehilite"><span class="n">logins</span><span class="p">.</span><span class="n">_id</span></code>
|ts| | The ts of the record |</p>
</blockquote>
<h3 id="table-operations">table operations</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|orgs| | The id of org the record belongs to | ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code> |
|server_ts|server_ts| The server ts of the record |
|devices| device_id| The device which emits this record | Type change to CHAR|
|op_ts| op_ts | The ts of the record from device 
|op_ip| op_ip | The ip of the device |
|op_type|op_type| The type of the event|
|cycle_tm|cycle_tm| The cycle time of the record. It is the time difference form the next record of the same org, same device, the same type |
|machines|machine_id| The id of the machine of the device |
|machines_wo| machine_wo | The copied value of wo of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">wo</span></code>|
|machines_product| machine_product | The copied value of product of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">product</span></code>|
|machines_mold| machine_mold | The copied value of mold of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">mold</span></code>|
|machines_target| machine_target | The copied value of target of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">target</span></code>|</p>
</blockquote>
<h3 id="table-measures">table measures</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|orgs| | The id of org the record belongs to | ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code> |
|server_ts|server_ts| The server ts of the record |
|devices| device_id| The device which emits this record | Type change to CHAR|
|op_ts| op_ts | The ts of the record from device 
|op_ip| op_ip | The ip of the device |
|op_type|op_type| The type of the event|
|cycle_tm|cycle_tm| The cycle time of the record. It is the time difference form the next record of the same org, same device, the same type |
|machines|machine_id| The id of the machine of the device |
|machines_wo| machine_wo | The copied value of wo of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">wo</span></code>|
|machines_product| machine_product | The copied value of product of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">product</span></code>|
|machines_mold| machine_mold | The copied value of mold of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">mold</span></code>|
|machines_target| machine_target | The copied value of target of the machine of the device| ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">target</span></code>|
|measure_x | | The x data of measure.|
|measure_y | | The y data of measure.|
|measure_z | | The z data of measure.|
|measure_d1 | | The d1 data of measure.|
|measure_d2 | | The d2 data of measure.|
|measure_d3 | | The d3 data of measure.|
|measure_c1 | | The c1 data of measure.|
|measure_c2 | | The c2 data of measure.|
|measure_c3 | | The c3 data of measure.|</p>
</blockquote>
<h3 id="table-shifts">table shifts</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|_id| | The internal id of the shift|
|orgs| | The id of org the shifts belongs to | ref to <code class="codehilite"><span class="n">orgs</span><span class="p">.</span><span class="n">_id</span></code> |
|class|class| The class of the shifts belongs to | |
|code |code | The code the shift. It can be reference to a short code or id from other system.|
|name |name | The name of the shift |
|effective_from | effective_from | The start date of the the shift (inclusive)|
|effective_till | effective_till | The till date of the the shift (inclusive)|
|tz| timezone | The timezone value of the shift. It should be copied from the tz value of the organization. |
|start|start | The start time string of the shift in 24 hours format <code class="codehilite"><span class="n">HH</span><span class="o">:</span><span class="n">MM</span></code>.|
|hr| length_hr| The number of hours of the shift. It can be decimal (e.g. 4.5). using start and hr to determine the shift end time|</p>
</blockquote>
<h3 id="table-units_headers">table units_headers</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|_id| | |The internal id of this units header|
|name | |The name of the header |
|who| | The id of user create / change the record |
|ts | | The ts of this record |</p>
</blockquote>
<h3 id="table-units">table units</h3>
<blockquote>
<p>|new|old|description| change remark|
|--|--|
|_id| ID |The internal id of this record| Type change to CHAR
|headers| |The id of unit header | ref to <code class="codehilite"><span class="n">units_headers</span><span class="p">.</span><span class="n">_id</span></code>|
|machines| machine_id | The id of the machine attached | ref to <code class="codehilite"><span class="n">machines</span><span class="p">.</span><span class="n">_id</span></code>|
|devices| device_id  | The id of the device attached | ref to <code class="codehilite"><span class="n">devices</span><span class="p">.</span><span class="n">_id</span></code> |
|status| | The status of the record | <code class="codehilite"><span class="n">enabled</span></code>, <code class="codehilite"><span class="n">disabled</span></code>|</p>
</blockquote>
<h3 id="view-v_current_shifts">view v_current_shifts</h3>
<h2 id="interfaces">Interfaces</h2>
<p>This document is to describe the design of iot server machine interface version 2.</p>
<p>The big change of this version of the api is to</p>
<ol>
<li>introduce version label in the api  </li>
<li>support both HTTP / Websocket protocols</li>
<li>support multiple organization in one server</li>
<li>introduce authentication of DI.</li>
</ol>
<p>As the previous version, there are still 3 major types of interfaces interacted with users and devices.</p>
<ol>
<li><code class="codehilite"><span class="n">MI</span></code> - machine interface</li>
<li><code class="codehilite"><span class="n">DI</span></code> - data interface</li>
<li><code class="codehilite"><span class="n">UI</span></code> - user interface</li>
</ol>
<h2 id="di">DI</h2>
<p>Most of the data communication between client and server is via Data Interface (DI).</p>
<p><strong>Protocol</strong></p>
<p><code class="codehilite"><span class="n">DI</span></code> is working under HTTP protocol.</p>
<p><strong>General Endpoint</strong></p>
<p>The general endpoint is <code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span></code> suffixed by additional <strong>DI path</strong> of specific DI functions.</p>
<p><strong>General Response</strong></p>
<p>The general format of response of DI is <code class="codehilite"><span class="err">{</span><span class="n">error</span><span class="p">,</span> <span class="k">data</span><span class="err">}</span></code>. If there is an error, there is an <code class="codehilite"><span class="n">error</span></code> value, otherwise the <code class="codehilite"><span class="n">error</span></code> is null or empty. If there is any data return, <code class="codehilite"><span class="k">data</span></code> may be array or object. It is implemented centrally in <code class="codehilite"><span class="n">ctxReturn</span></code> in <code class="codehilite"><span class="n">core</span><span class="o">-</span><span class="n">bus</span><span class="p">.</span><span class="n">js</span></code> in this version.</p>
<p><strong>DI Paths</strong></p>
<table>
<thead>
<tr>
<th>method</th>
<th>DI path</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span></code></td>
<td>The api endpoint of the version 1 (protected api)</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span></code></td>
<td>The api endpoint of the version 1 (public api)</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="k">reset</span><span class="o">-</span><span class="n">password</span></code></td>
<td>submit to reset-password process</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">sing</span><span class="o">-</span><span class="k">on</span></code></td>
<td>submit to sign-on process</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">sing</span><span class="o">-</span><span class="k">in</span></code></td>
<td>submit to sign-in process</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">verify</span><span class="o">-</span><span class="k">reset</span><span class="o">-</span><span class="n">password</span></code></td>
<td>submit to verify the reset-password token</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span></code></td>
<td>return the signed-in user info</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span></code></td>
<td>submit to change the signed-in user info</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">change</span><span class="o">-</span><span class="n">password</span></code></td>
<td>submit to change the signed-in user password</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">orgs</span></code></td>
<td>return the list of orgs the user is able to access</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="k">off</span></code></td>
<td>submit to sign-off process</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span></code></td>
<td>return the list of orgs the user is able to access</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span></code></td>
<td>return the org data of the <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span></code></td>
<td>submit to change the org data of the <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">clear</span><span class="o">-</span><span class="n">org</span><span class="o">-</span><span class="k">key</span></code></td>
<td>submit to clear the orgKey of the org</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="k">new</span><span class="o">-</span><span class="n">org</span><span class="o">-</span><span class="k">key</span></code></td>
<td>submit to generate a new orgKey of the org</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span></code></td>
<td>return the list of devices of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span></code></td>
<td>submit to register a new devices of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code></td>
<td>return data of the device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code></td>
<td>submit to change the data of device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="k">new</span><span class="o">-</span><span class="n">token</span></code></td>
<td>submit to create new token of device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">logins</span></code></td>
<td>return the list of logins of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">logins</span></code></td>
<td>submit to create a new member login of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span></code></td>
<td>return the list of machines of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span></code></td>
<td>submit to add a new machine of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code></td>
<td>return the data of machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code></td>
<td>submit to change the data of machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span><span class="o">/</span><span class="k">work</span><span class="o">-</span><span class="n">status</span></code></td>
<td>submit to change the work status data of machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">shifts</span></code></td>
<td>return the list of shifts of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span></code></td>
<td>return the list of all units of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="p">:</span><span class="n">unit_id</span></code></td>
<td>return the unit record of <code class="codehilite"><span class="p">:</span><span class="n">unit_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span></code></td>
<td>submit to create a new unit record of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>DELETE</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="p">:</span><span class="n">unit_id</span></code></td>
<td>submit to remove the new unit record <code class="codehilite"><span class="p">:</span><span class="n">unit_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code></td>
<td>return a list of units associated with the device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="n">machine</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code></td>
<td>submit to associate device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> with machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="p">:</span><span class="n">device2_id</span></code></td>
<td>submit to associate two devices <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> and <code class="codehilite"><span class="p">:</span><span class="n">device2_id</span></code> of org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">machine</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code></td>
<td>return a list of units associated with the machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">machine</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span><span class="o">/</span><span class="n">device</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code></td>
<td>submit to associate device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> with machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>PUT</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">units</span><span class="o">/</span><span class="k">of</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span><span class="o">/</span><span class="p">:</span><span class="n">machine2_id</span></code></td>
<td>submit to associate two machines <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> and <code class="codehilite"><span class="p">:</span><span class="n">machine2_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">_</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="p">:</span><span class="k">table</span></code></td>
<td>generic selection api for a single table/view</td>
</tr>
<tr>
<td>GET</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">_</span><span class="o">/</span><span class="n">t</span><span class="o">/</span><span class="p">:</span><span class="k">table</span><span class="o">/</span><span class="p">:</span><span class="n">id</span></code></td>
<td>generic selection api for a single table/view</td>
</tr>
<tr>
<td>POST</td>
<td><code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">_</span><span class="o">/</span><span class="n">q</span></code></td>
<td>generic sql runner api (only for development)</td>
</tr>
</tbody>
</table>
<h2 id="di-details">DI Details</h2>
<h3 id="reset-password">reset-password</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="k">reset</span><span class="o">-</span><span class="n">password</span></code>.  body: <code class="codehilite"><span class="err">{</span><span class="n">email</span><span class="err">}</span></code></p>
<p>This DI only supports reset by providing the login email.<br />
This DI will trigger back-end process to generate a <strong>reset-password-token</strong> and submit an email to the <code class="codehilite"><span class="n">email</span></code>.</p>
</blockquote>
<h3 id="sign-on">sign-on</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="k">on</span></code>. body: <code class="codehilite"><span class="err">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">pwds</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span> <span class="n">uid</span><span class="err">}</span></code></p>
<p>This DI will submit request to server to create a new login.<br />
<code class="codehilite"><span class="n">name</span></code>, <code class="codehilite"><span class="n">pwds</span></code>, <code class="codehilite"><span class="n">email</span></code> are mandatory. <code class="codehilite"><span class="n">mobile</span></code> and <code class="codehilite"><span class="n">uid</span></code> are optional. If no <code class="codehilite"><span class="n">uid</span></code>, <code class="codehilite"><span class="n">email</span></code> will be the <code class="codehilite"><span class="n">uid</span></code>.<br />
If the process success, it will return the <code class="codehilite"><span class="n">me</span></code> object of the sign-on user. But it will NOT automatically sign in.<br />
sing-on process will also create personal org in back-end.</p>
</blockquote>
<h3 id="sign-in">sign-in</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="k">in</span></code>. body: <code class="codehilite"><span class="err">{</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pwds</span> <span class="err">}</span></code></p>
<p>This DI will submit request to server to sign in.<br />
If the process success, it will return the <code class="codehilite"><span class="err">{</span><span class="k">data</span><span class="p">:</span><span class="err">{</span><span class="n">ok</span><span class="p">:</span><span class="k">true</span><span class="err">}}</span></code> object. Otherwise it returns <code class="codehilite"><span class="err">{</span><span class="n">error</span><span class="p">:</span><span class="ss">&quot;&lt;error&gt;&quot;</span><span class="err">}</span></code> object.</p>
</blockquote>
<h3 id="verify-reset-password">verify-reset-password</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="n">pdata</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">verify</span><span class="o">-</span><span class="k">reset</span><span class="o">-</span><span class="n">password</span></code>. body: <code class="codehilite"><span class="err">{</span><span class="n">email</span><span class="p">,</span> <span class="n">reset_pwd_token</span><span class="err">}</span></code></p>
<p>This DI is to verify the reset-password-token by providing the login email.<br />
If the process success, it will return the <code class="codehilite"><span class="err">{</span><span class="k">data</span><span class="p">:</span><span class="err">{</span><span class="n">ok</span><span class="p">:</span><span class="k">true</span><span class="err">}}</span></code> object.</p>
</blockquote>
<h3 id="me">me</h3>
<blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span></code>.</p>
<p>This DI is to get the signed-in user info. No params is required.</p>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span></code>.  body: <code class="codehilite"><span class="err">{</span><span class="n">name</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span> <span class="n">tz</span><span class="err">}</span></code></p>
<p>This DI is to update the signed-in user info.<br />
All the params are optional. If <code class="codehilite"><span class="n">pwds</span></code> is changed, back-end will send an email to notify the email owner. If <code class="codehilite"><span class="n">email</span></code> changed, back-end will send an email to notify the original email address owner.</p>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">change</span><span class="o">-</span><span class="n">password</span></code>. body : <code class="codehilite"><span class="err">{</span><span class="n">pwdo</span><span class="p">,</span> <span class="n">pwds</span><span class="err">}</span></code></p>
<p>This DI is to change the password of the signed-in user.<br />
If the process success, it will return <code class="codehilite"><span class="err">{</span><span class="k">data</span><span class="p">:</span><span class="err">{</span><span class="n">ok</span><span class="p">:</span><span class="k">true</span><span class="err">}}</span></code>.</p>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">orgs</span></code></p>
<p>This DI is to get the list of orgs which the signed-in user is able access. No params is required.<br />
The each record in the list of orgs has a field <code class="codehilite"><span class="n">roles</span></code> to indicate the role of the signed-in user of the org.</p>
</blockquote>
<h3 id="sign-off">sign-off</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="k">off</span></code>.</p>
<p>This DI is to submit to process a sign-off process. No params is required.<br />
After process, the server will response <code class="codehilite"><span class="err">{</span><span class="k">data</span><span class="p">:</span><span class="err">{</span><span class="n">ok</span><span class="p">:</span><span class="k">true</span><span class="err">}}</span></code> object.</p>
</blockquote>
<h3 id="orgs_1">orgs</h3>
<blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span></code>.</p>
<p>This DI is to get the list of orgs which the signed-in user is able access. No params is required.<br />
Same as <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">me</span><span class="o">/</span><span class="n">orgs</span></code>.</p>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span></code>.</p>
<p>This DI is to get the data of a specific org of <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></p>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span></code>.  Body: <code class="codehilite"><span class="err">{</span><span class="n">name</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span><span class="n">tz</span><span class="err">}</span></code></p>
<p>This DI is to submit a change of the data of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.</p>
</blockquote>
<h3 id="clear-org-key">clear-org-key</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">clear</span><span class="o">-</span><span class="n">org</span><span class="o">-</span><span class="k">key</span></code>.</p>
<p>This DI is to submit to clear the orgKey of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></p>
</blockquote>
<h3 id="new-org-key">new-org-key</h3>
<blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="k">new</span><span class="o">-</span><span class="n">org</span><span class="o">-</span><span class="k">key</span></code>.</p>
<p>This DI is to generate a new orgKey of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></p>
</blockquote>
<h3 id="devices">devices</h3>
<blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span></code>.</p>
<p>This DI is to get the list of all devices of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.<br />
This DI supports <strong>filter query</strong>.
</p>
<p><code class="codehilite"><span class="n">PUT</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span></code>. Body: <code class="codehilite"><span class="err">{</span> <span class="n">physical_id</span><span class="p">,</span> <span class="k">usage</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">max_machine</span> <span class="err">}</span></code></p>
<p>This DI is to submit to register a new device of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.<br />
<code class="codehilite"><span class="n">physical_id</span></code> is mandatory. others are optional. <code class="codehilite"><span class="k">type</span></code> will be '' if it is not 'virtual-device'. <code class="codehilite"><span class="n">max_machine</span></code> is default to 1.<br />
If process is success it will return a device data object with at least the assigned <code class="codehilite"><span class="n">_id</span></code> and <code class="codehilite"><span class="n">token</span></code> fields.<br />
The register program has to write the <code class="codehilite"><span class="n">_id</span></code> and <code class="codehilite"><span class="n">token</span></code> back to the device, otherwise the device may not be able to connect to the server.</p>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code>.</p>
<p>This DI is to get the data of the device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.<br />
No <code class="codehilite"><span class="n">token</span></code> of devices will be shown in this DI. </p>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span></code>.  Body: <code class="codehilite"><span class="err">{</span> <span class="k">usage</span> <span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">max_machine</span><span class="p">,</span> <span class="k">type</span><span class="err">}</span></code></p>
<p>This DI is to submit to change the data of device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code> of org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.<br />
It will return new device object if success.</p>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="k">new</span><span class="o">-</span><span class="n">token</span></code>. </p>
<p>This DI is to submit to create a new device token of device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code>. 
This DI will then return the object: <code class="codehilite"><span class="err">{</span> <span class="n">_id</span><span class="p">,</span> <span class="n">token</span> <span class="p">,</span><span class="n">tokeTs</span><span class="err">}</span></code>.<br />
The register program has to write the newly created <code class="codehilite"><span class="n">token</span></code> back to the device.
</p>
</blockquote>
<h3 id="logins_1">logins</h3>
<blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">logins</span></code>.</p>
<p>This DI is to get the list of the logins of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.</p>
<p><code class="codehilite"><span class="n">PUT</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">logins</span></code>. Body: <code class="codehilite"><span class="err">{</span><span class="n">uid</span><span class="p">,</span> <span class="n">pwds</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span><span class="n">roles</span><span class="err">}</span></code>.</p>
<p>This DI is to submit to create a new member login of org.<br />
The member created with this DI is a <strong>member</strong> login of the org.<br />
<code class="codehilite"><span class="n">uid</span></code> , <code class="codehilite"><span class="n">pwds</span></code> and <code class="codehilite"><span class="n">roles</span></code> are mandatory. Others are optional. </p>
</blockquote>
<h3 id="machines">machines</h3>
<blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span></code>.</p>
<p>This DI is to get the list of machines of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.<br />
This DI supports <strong>filter query</strong>.</p>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code>.  </p>
<p>This DI is to get the data of the machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code></p>
<p><code class="codehilite"><span class="n">PUT</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span></code>. Body: <code class="codehilite"><span class="err">{</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="k">location</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">cum_count</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">mold</span><span class="p">,</span> <span class="n">target</span> <span class="err">}</span></code>.</p>
<p>This DI is to submit to register a new machine of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.</p>
<p>If process is success it will return a machine data object with the assigned <code class="codehilite"><span class="n">_id</span></code> field.</p>
</blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span></code>.</p>
<blockquote>
<p>This DI is to submit to change the machine <code class="codehilite"><span class="p">:</span><span class="n">machine_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>. The Post body is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">class</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="k">location</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">cum_count</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">mold</span><span class="p">,</span> <span class="n">target</span> <span class="err">}</span></code></p>
<p>If process is success it will return a machine data object.</p>
</blockquote>
<p><code class="codehilite"><span class="n">POST</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">machines</span><span class="o">/</span><span class="p">:</span><span class="n">machine_id</span><span class="o">/</span><span class="k">work</span><span class="o">-</span><span class="n">status</span></code>.</p>
<blockquote>
<p>This DI is to submit to change the work status data of device <code class="codehilite"><span class="p">:</span><span class="n">device_id</span></code>. The Post body is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span> <span class="n">wo</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">mold</span><span class="p">,</span> <span class="n">target</span> <span class="p">,</span> <span class="n">status</span><span class="err">}</span></code>
All params are optional.
This DI will then return the object <code class="codehilite"><span class="err">{</span><span class="n">ok</span><span class="p">:</span><span class="k">true</span><span class="err">}</span></code> if success.
</p>
</blockquote>
<h3 id="shifts">shifts</h3>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">shifts</span></code>.</p>
<blockquote>
<p>This DI is to get the list of shifts data of orgs <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.</p>
</blockquote>
<p><code class="codehilite"><span class="k">GET</span></code> <code class="codehilite"><span class="p">.</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="n">orgs</span><span class="o">/</span><span class="p">:</span><span class="n">org_id</span><span class="o">/</span><span class="n">shifts</span><span class="o">/</span><span class="p">:</span><span class="n">shift_id</span></code>.</p>
<blockquote>
<p>This DI is to get the data of the shift <code class="codehilite"><span class="p">:</span><span class="n">shift_id</span></code> of the org <code class="codehilite"><span class="p">:</span><span class="n">org_id</span></code>.
</p>
</blockquote>
<p>&nbsp;</p>
<h2 id="di-legacy-paths">DI Legacy Paths</h2>
<p>There are some legacy paths used in Web User Interface (WUI or simply UI)</p>
<table>
<thead>
<tr>
<th>legacy path</th>
<th>location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">machines</span><span class="o">-</span><span class="k">current</span><span class="o">-</span><span class="n">shift</span><span class="o">-</span><span class="n">status</span><span class="o">/</span><span class="n">injection</span></code></td>
<td><code class="codehilite"><span class="n">components</span><span class="o">/</span><span class="n">Dashboard</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_q</span></code></td>
<td><code class="codehilite"><span class="n">components</span><span class="o">/</span><span class="n">DatabaseDebugger</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span></code></td>
<td><code class="codehilite"><span class="n">components</span><span class="o">/</span><span class="n">DayOperations</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span></code></td>
<td><code class="codehilite"><span class="n">components</span><span class="o">/</span><span class="n">DaySummary</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">devices</span><span class="o">?</span><span class="k">where</span><span class="o">=</span><span class="n">device_id</span><span class="o">=</span></code></td>
<td><code class="codehilite"><span class="n">components</span><span class="o">/</span><span class="n">DeviceBasic</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span><span class="k">where</span><span class="o">=</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">HelloAnalysis</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_hello</span><span class="o">?</span><span class="k">where</span><span class="o">=</span><span class="n">device_id</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">HelloAnalysis</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_hello</span><span class="o">?</span><span class="k">where</span><span class="o">=</span><span class="n">op_type</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span> <span class="k">and</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">LastHello</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">LastOperations</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite">/data/_t/machines?where=id=<span class="cp">${</span><span class="n">this</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">compoents</span><span class="o">/</span><span class="n">MachineBasic</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">machines</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">MachineOperations</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">operations</span><span class="o">?</span><span class="k">where</span><span class="o">=</span><span class="n">machine_id</span><span class="o">=</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">MachineOperations</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span><span class="k">where</span><span class="o">=</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">MachinesStops</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite">/data/_t/machines?where=id=<span class="cp">${</span><span class="n">this</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">MachineWorkStatus</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">v_operations</span><span class="o">?</span><span class="k">where</span><span class="o">=</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">components</span><span class="o">/</span><span class="n">Projection</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">oprerations</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">Debugger</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">devices</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">Devices</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">units</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">Devices</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">machines</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">Machines</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">units</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">Machines</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">machines</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">MachinesReport</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">_t</span><span class="o">/</span><span class="n">units</span></code></td>
<td><code class="codehilite"><span class="o">/</span><span class="n">views</span><span class="o">/</span><span class="n">MachinesReport</span><span class="p">.</span><span class="n">vue</span></code></td>
</tr>
</tbody>
</table>
<h2 id="mi-legacy-paths">MI Legacy Paths</h2>
<table>
<thead>
<tr>
<th>legacy path</th>
<th>location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="ss">&quot;http://&quot;</span><span class="p">..</span><span class="n">SERVER_DOMAIN</span><span class="p">..</span><span class="ss">&quot;/time&quot;</span></code></td>
<td>wifi.lua <code class="codehilite"><span class="n">getServerTime</span><span class="p">()</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="ss">&quot;..SERVER_DOMAIN..&quot;</span><span class="o">/</span><span class="n">record</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="ss">&quot;..DEVICE_ID..&quot;</span><span class="o">/</span><span class="ss">&quot;..ip..&quot;</span><span class="o">/</span><span class="err">&quot;</span><span class="p">..</span><span class="n">sec</span></code></td>
<td>wifi.lua <code class="codehilite"><span class="n">sendRecord</span><span class="p">()</span></code></td>
</tr>
<tr>
<td><code class="codehilite"><span class="ss">&quot;http://&quot;</span><span class="p">..</span><span class="n">SERVER_DOMAIN</span><span class="p">..</span><span class="ss">&quot;/record/0/&quot;</span><span class="p">..</span><span class="n">DEVICE_ID</span><span class="p">..</span><span class="ss">&quot;/&quot;</span><span class="p">..</span><span class="n">ip</span><span class="p">..</span><span class="ss">&quot;/&quot;</span><span class="p">..</span><span class="n">sec</span><span class="p">..</span><span class="ss">&quot;/&quot;</span><span class="p">..</span><span class="n">m</span></code></td>
<td>wifi.lua <code class="codehilite"><span class="n">sendHello</span><span class="p">()</span></code></td>
</tr>
</tbody>
</table>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>&nbsp;</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h2 id="mi">MI</h2>
<p>Devices are using the <code class="codehilite"><span class="n">MI</span></code> to communicate with the IoT Server.  <code class="codehilite"><span class="n">MI</span></code> version 1 (v1) provides interfaces with HTTP and WebSocket (WS) protocol.</p>
<p><strong>Prerequisite</strong>:</p>
<ul>
<li>The Device must be registered in an Organization already before calling the <code class="codehilite"><span class="n">MI</span></code>.</li>
<li>The Device must be enabled before calling the <code class="codehilite"><span class="n">MI</span></code>.</li>
<li>The Organization of the Device must be set to allow collecting data from the <code class="codehilite"><span class="n">MI</span></code>.</li>
</ul>
<p><strong>General MI</strong></p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>(Method)</th>
<th>General Format of API Endpoints</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP</td>
<td>GET</td>
<td><code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span><span class="o">/</span> <span class="p">...</span></code></td>
</tr>
<tr>
<td>HTTP</td>
<td>POST</td>
<td><code class="codehilite"><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span></code></td>
</tr>
<tr>
<td>WS</td>
<td></td>
<td><code class="codehilite"><span class="n">ws</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">ws</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span><span class="o">/</span> <span class="p">...</span></code></td>
</tr>
</tbody>
</table>
<p>Where</p>
<ul>
<li><code class="codehilite"><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span></code> is the server endpoint of the a user or organization. It is assigned by IoT Server internally.</li>
<li><code class="codehilite"><span class="p">:</span><span class="n">orgKey</span></code> Each organization can be assigned a unique key at a time. The Organization can re-generate <code class="codehilite"><span class="p">:</span><span class="n">orgKey</span></code> at any time. The change of <code class="codehilite"><span class="p">:</span><span class="n">orgKey</span></code> of an Org results that all devices of the Org is to be re-registered.</li>
</ul>
<h2 id="mi-json">MI JSON</h2>
<p>MI JSON format message contains the following attributes:</p>
<table>
<thead>
<tr>
<th>attribute name</th>
<th>symbol</th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>action</td>
<td><code class="codehilite"><span class="p">:</span><span class="n">action</span></code></td>
<td>define action type of the JSON message.</td>
</tr>
<tr>
<td>action descriptor</td>
<td><code class="codehilite"><span class="p">:</span><span class="k">descriptor</span></code></td>
<td>further descriptor for the action.</td>
</tr>
<tr>
<td>data content</td>
<td><code class="codehilite"><span class="p">:</span><span class="k">data</span><span class="o">-</span><span class="n">content</span></code></td>
<td>the content body of the data field.</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;:action&quot;</span><span class="o">:</span><span class="s2">&quot;:descriptor&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="s2">&quot;:data-content&quot;</span>
<span class="p">}</span>
</pre></div>

<p><strong>Action</strong></p>
<table>
<thead>
<tr>
<th><code class="codehilite"><span class="p">:</span><span class="n">action</span></code></th>
<th>explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="n">req</span></code></td>
<td>Request action. It requests something defined by the action descriptor.</td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">res</span></code></td>
<td>Response action. It response the corresponding request action.</td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">event</span></code></td>
<td>Event submission action. It submits an event defined by the action descriptor.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>action</th>
<th>descriptor</th>
<th>originator</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td><code class="codehilite"><span class="n">req</span></code>/<code class="codehilite"><span class="n">res</span></code></td>
<td><code class="codehilite"><span class="n">auth</span></code></td>
<td>server</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">req</span></code>/<code class="codehilite"><span class="n">res</span></code></td>
<td><code class="codehilite"><span class="n">time</span></code></td>
<td>device</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">event</span></code></td>
<td><code class="codehilite"><span class="n">counter</span></code></td>
<td>device</td>
<td>submit the <em>event data</em>. There are many different type of event data. The type is defined the data content.</td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">event</span></code></td>
<td><code class="codehilite"><span class="n">bulk</span><span class="o">-</span><span class="n">counter</span></code></td>
<td>device</td>
<td></td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">event</span></code></td>
<td><code class="codehilite"><span class="n">message</span></code></td>
<td>device</td>
<td>just print the message to console.</td>
</tr>
<tr>
<td><code class="codehilite"><span class="n">event</span></code></td>
<td><code class="codehilite"><span class="n">hello</span></code></td>
<td>device</td>
<td>save the hello message in server.</td>
</tr>
</tbody>
</table>
<h2 id="mi-details">MI Details</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Protocol</th>
<th>Originator</th>
<th>Playload example</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth req</td>
<td>ws</td>
<td>Server</td>
<td><pre>{req:"auth",data:{...}}</pre></td>
<td>Server requests Device to provide authentication info.</td>
</tr>
<tr>
<td>auth res</td>
<td>ws</td>
<td>Device</td>
<td><pre>{res:"auth",data:{...}}</pre></td>
<td>Devices response to provide auth info.</td>
</tr>
<tr>
<td>counter event</td>
<td>get</td>
<td>Device</td>
<td><pre>./counter/:type/:device_id/:ts/:ip</pre></td>
<td>Device emit this event to record counter with timestamp</td>
</tr>
<tr>
<td>measure event</td>
<td>ws</td>
<td>Device</td>
<td><pre>{event:"event",data:{...}}</pre></td>
<td>Device emit this event to record measures with timestamp</td>
</tr>
<tr>
<td>counter event</td>
<td>ws</td>
<td>Device</td>
<td><pre>{event:"counter",data:{...}}</pre></td>
<td>Device emit this event to record counter with timestamp</td>
</tr>
<tr>
<td>hello event</td>
<td>get</td>
<td>Device</td>
<td><pre>./hello/:device_id/:ts/:ip/:message</pre></td>
<td>Devices emits this event when reboot/restart.</td>
</tr>
<tr>
<td>hello event</td>
<td>ws</td>
<td>Device</td>
<td><pre>{event:"hello",data:{...}}</pre></td>
<td>Devices emits this event when reboot/restart.</td>
</tr>
<tr>
<td>resend req</td>
<td>post</td>
<td>Device</td>
<td><pre>./resend</pre><pre>{data:[...]}</pre></td>
<td>Device re-sends all unsent events</td>
</tr>
<tr>
<td>resend req</td>
<td>ws</td>
<td>Device</td>
<td><pre>{req:"resend",data:[...]}</pre></td>
<td>Device re-sends all unsent events</td>
</tr>
<tr>
<td>resend res</td>
<td>ws</td>
<td>Server</td>
<td><pre>{res:"resend",data:{...}}</pre></td>
<td>Server notifies Device the result of resend.</td>
</tr>
<tr>
<td>time event</td>
<td>ws</td>
<td>Server</td>
<td><pre>{event:"time",data:{...}}</pre></td>
<td>Server broadcasts server to time to all connected devices</td>
</tr>
<tr>
<td>time req</td>
<td>get</td>
<td>Device</td>
<td><pre>./time/</pre></td>
<td>Device requests server time</td>
</tr>
<tr>
<td>time req</td>
<td>ws</td>
<td>Device</td>
<td><pre>{req:"time"}</pre></td>
<td>Device requests server time</td>
</tr>
<tr>
<td>time res</td>
<td>ws</td>
<td>Server</td>
<td><pre>{res:"time",data:{...}}</pre></td>
<td>Server responses the time request</td>
</tr>
</tbody>
</table>
<h3 id="http-vs-ws">HTTP vs WS</h3>
<p>The following table summarizes the difference.</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>HTTP</th>
<th>WS</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>counter</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>hello</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>measure</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>resend</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>time request</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>time broadcast</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>remote device config</td>
<td></td>
<td>Y</td>
</tr>
</tbody>
</table>
<h3 id="auth">auth</h3>
<blockquote>
<p><code class="codehilite"><span class="n">WS</span></code> only.</p>
<p>Server sends <strong>auth request</strong> message as the following format:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;req&quot;</span><span class="p">:</span><span class="ss">&quot;auth&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;otp&quot;</span><span class="p">:</span><span class="ss">&quot;&lt;one-time-password&gt;&quot;</span><span class="err">}</span><span class="err">}</span></code></p>
<p>After receiving the <code class="codehilite"><span class="err">{</span><span class="ss">&quot;req&quot;</span><span class="p">:</span><span class="ss">&quot;auth&quot;</span><span class="err">}</span></code> from server, the device needs to emit <strong>auth response</strong> message to server. Otherwise the ws connection will be closed by the server. The format of the <strong>auth response</strong> message is:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;res&quot;</span><span class="p">:</span><span class="ss">&quot;auth&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;id&quot;</span><span class="p">:</span><span class="ss">&quot;&lt;device-id&gt;&quot;</span><span class="p">,</span><span class="ss">&quot;token&quot;</span><span class="p">:</span><span class="ss">&quot;&lt;session-token&gt;&quot;</span><span class="err">}</span><span class="err">}</span></code></p>
<p>The <code class="codehilite"><span class="k">session</span><span class="o">-</span><span class="n">token</span></code> = sessionToken(device_token, data.otp)</p>
</blockquote>
<h3 id="counter">counter</h3>
<blockquote>
<p><code class="codehilite"><span class="n">HTTP</span></code> <code class="codehilite"><span class="n">WS</span></code>.</p>
<p>Device emits counter event to the server to record an occurrence and the timestamp of a specify type of a counter event.</p>
<blockquote>
<p><strong>HTTP</strong>: The HTTP path of the event is of the foramt:</p>
<p><code class="codehilite"><span class="n">js</span><span class="k">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span><span class="o">/</span><span class="n">counter</span><span class="o">/</span><span class="p">:</span><span class="k">type</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="p">:</span><span class="n">ts</span><span class="o">/</span><span class="p">:</span><span class="n">ip</span></code></p>
<p>The path will return a plain text <code class="codehilite"><span class="n">ok</span></code> if the request is done.</p>
</blockquote>
<p>&nbsp;</p>
<blockquote>
<p><strong>WS</strong>: The format of the event message is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;counter&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;device_id&quot;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>        <span class="o">//</span> <span class="n">device</span> <span class="n">internal</span> <span class="n">id</span> <span class="n">registered</span> <span class="k">in</span> <span class="n">the</span> <span class="n">server</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;&lt;counter-type&gt;&quot;</span><span class="p">,</span>    <span class="o">//</span> <span class="k">operation</span> <span class="k">type</span> <span class="p">(</span><span class="n">injection</span><span class="p">)</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="mi">1509890989</span><span class="p">,</span>            <span class="o">//</span> <span class="k">operation</span> <span class="k">timestamp</span> <span class="k">in</span> <span class="n">unix</span> <span class="n">epoch</span><span class="ss">&quot;ip&quot;</span><span class="p">:</span><span class="ss">&quot;192.168.0.101&quot;</span>        <span class="o">//</span> <span class="n">device</span> <span class="n">ip</span><span class="err">}</span><span class="err">}</span></code></p>
</blockquote>
</blockquote>
<h3 id="hello">hello</h3>
<blockquote>
<p><code class="codehilite"><span class="n">HTTP</span></code> <code class="codehilite"><span class="n">WS</span></code>.</p>
<p>Device will emit hello event message to the server if the device restart/reboot.</p>
<blockquote>
<p><strong>HTTP</strong>: The HTTP path of the event is of the foramt:</p>
<p><code class="codehilite"><span class="n">js</span><span class="k">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKeey</span><span class="o">/</span><span class="n">hello</span><span class="o">/</span><span class="p">:</span><span class="n">device_id</span><span class="o">/</span><span class="p">:</span><span class="n">ts</span><span class="o">/</span><span class="p">:</span><span class="n">ip</span><span class="o">/</span><span class="p">:</span><span class="n">message</span></code></p>
<p>Note that the <code class="codehilite"><span class="p">:</span><span class="n">message</span></code> in this HTTP path should be Base64 formatted.</p>
</blockquote>
<p>&nbsp;</p>
<blockquote>
<p><strong>WS</strong>: The format of the event message is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;hello&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;device_id&quot;</span><span class="p">:</span><span class="mi">123456</span><span class="p">,</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="mi">1509890989</span><span class="p">,</span>      <span class="o">//</span> <span class="k">operation</span> <span class="k">timestamp</span> <span class="k">in</span> <span class="n">unix</span> <span class="n">epoch</span><span class="ss">&quot;ip&quot;</span><span class="p">:</span><span class="ss">&quot;192.168.0.101&quot;</span>  <span class="o">//</span> <span class="n">device</span> <span class="n">ip</span><span class="ss">&quot;message&quot;</span><span class="p">:</span><span class="ss">&quot;&lt;hello-information&gt;&quot;</span> <span class="o">//</span> <span class="n">plain</span> <span class="nb">text</span> <span class="n">string</span><span class="err">}</span><span class="err">}</span></code></p>
<p>Note that the <code class="codehilite"><span class="p">:</span><span class="n">message</span></code> should be in plain text.</p>
</blockquote>
</blockquote>
<h3 id="measure">measure</h3>
<blockquote>
<p><code class="codehilite"><span class="n">WS</span></code> only.</p>
<p>Device emits measure event to the server to record an measured data and the timestamp of a specify type of a measure event.</p>
<blockquote>
<p><strong>WS</strong>: The format of the event message is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;measure&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;device_id&quot;</span><span class="p">:</span> <span class="mi">123456</span><span class="p">,</span>        <span class="o">//</span> <span class="n">device</span> <span class="n">internal</span> <span class="n">id</span> <span class="n">registered</span> <span class="k">in</span> <span class="n">the</span> <span class="n">server</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;acceleration&quot;</span><span class="p">,</span>    <span class="o">//</span> <span class="k">operation</span> <span class="k">type</span> <span class="p">(</span><span class="n">injection</span><span class="p">)</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="mi">1509890989</span><span class="p">,</span>            <span class="o">//</span> <span class="k">operation</span> <span class="k">timestamp</span> <span class="k">in</span> <span class="n">unix</span> <span class="n">epoch</span><span class="ss">&quot;ip&quot;</span><span class="p">:</span><span class="ss">&quot;192.168.0.101&quot;</span>        <span class="o">//</span> <span class="n">device</span> <span class="n">ip</span><span class="ss">&quot;measure_x&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="ss">&quot;measure_y&quot;</span><span class="p">:</span><span class="mi">21</span><span class="p">,</span><span class="ss">&quot;measure_z&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="err">}</span><span class="err">}</span></code></p>
</blockquote>
</blockquote>
<h3 id="resend">resend</h3>
<blockquote>
<p><code class="codehilite"><span class="n">HTTP</span></code> <code class="codehilite"><span class="n">WS</span></code>.</p>
<blockquote>
<p><strong>HTTP</strong>: Post the <strong>resend</strong> data to the path:
<code class="codehilite"><span class="n">js</span><span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span><span class="o">/</span><span class="n">resend</span></code></p>
<p>The format of data body of the POST request is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="k">data</span><span class="p">:[</span> <span class="o">&lt;</span><span class="nb">array</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">event</span><span class="o">-</span><span class="n">message</span><span class="o">&gt;</span><span class="p">]</span><span class="err">}</span><span class="err"></span><span class="n">wzxhzdk</span><span class="p">:</span><span class="mi">1</span><span class="err"></span><span class="p">[</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;counter&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;device_id&quot;</span><span class="p">:</span><span class="mi">123456</span><span class="p">,</span>   <span class="o">//</span> <span class="n">device</span> <span class="n">physical</span> <span class="n">id</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;arm&quot;</span><span class="p">,</span>         <span class="o">//</span> <span class="k">operation</span> <span class="k">type</span> <span class="p">(</span><span class="n">robot</span> <span class="n">arm</span><span class="p">)</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="mi">1509890989</span><span class="p">,</span>      <span class="o">//</span> <span class="k">operation</span> <span class="k">timestamp</span> <span class="k">in</span> <span class="n">unix</span> <span class="n">epoch</span><span class="ss">&quot;ip&quot;</span><span class="p">:</span><span class="ss">&quot;192.168.0.101&quot;</span>  <span class="o">//</span> <span class="n">device</span> <span class="n">ip</span><span class="err">}</span><span class="err">}</span><span class="p">,</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;counter&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;device_id&quot;</span><span class="p">:</span><span class="mi">123456</span><span class="p">,</span>   <span class="o">//</span> <span class="n">device</span> <span class="n">physical</span> <span class="n">id</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;arm&quot;</span><span class="p">,</span>         <span class="o">//</span> <span class="k">operation</span> <span class="k">type</span> <span class="p">(</span><span class="n">robot</span> <span class="n">arm</span><span class="p">)</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="mi">1509891990</span><span class="p">,</span>      <span class="o">//</span> <span class="k">operation</span> <span class="k">timestamp</span> <span class="k">in</span> <span class="n">unix</span> <span class="n">epoch</span><span class="ss">&quot;ip&quot;</span><span class="p">:</span><span class="ss">&quot;192.168.0.101&quot;</span>  <span class="o">//</span> <span class="n">device</span> <span class="n">ip</span><span class="err">}</span><span class="err">}</span><span class="p">]</span></code>
When <strong>resend request</strong> is processed, the server will response a plain text <code class="codehilite"><span class="n">ok</span></code>.</p>
</blockquote>
<p>&nbsp;</p>
<blockquote>
<p><strong>WS</strong>: The format of the <strong>resend request</strong> message is:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;req&quot;</span><span class="p">:</span><span class="ss">&quot;resend&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:[</span><span class="o">&lt;</span><span class="nb">array</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">event</span><span class="o">-</span><span class="n">message</span><span class="o">&gt;</span><span class="p">]</span><span class="err">}</span></code>
<code class="codehilite"><span class="nb">array</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="n">event</span><span class="o">-</span><span class="n">message</span></code> is the same as those in HTTP POST.</p>
<p>After processing the resend request, the server will send <strong>resend response</strong> message to the device to notify the result. the response format is:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;res&quot;</span><span class="p">:</span><span class="ss">&quot;resend&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;ok&quot;</span><span class="p">:</span><span class="k">true</span><span class="err">}</span><span class="err">}</span></code></p>
</blockquote>
</blockquote>
<h3 id="time-broadcast">time broadcast</h3>
<blockquote>
<p><code class="codehilite"><span class="n">WS</span></code> only.</p>
<p>Server may send the server time to all connected devices. the time event message is as the following format:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;event&quot;</span><span class="p">:</span><span class="ss">&quot;time&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">time</span><span class="o">&gt;</span><span class="err">}</span><span class="err">}</span></code></p>
</blockquote>
<h3 id="time-request">time request</h3>
<blockquote>
<p><code class="codehilite"><span class="n">HTTP</span></code> <code class="codehilite"><span class="n">WS</span></code>.</p>
<p>The device may request server time for time adjustment regularly. </p>
<p>Note that the time value returned by this time request is in UNIX epoch.</p>
<blockquote>
<p><strong>HTTP</strong>:</p>
<p><code class="codehilite"><span class="n">js</span><span class="k">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="p">:</span><span class="n">org</span><span class="o">-</span><span class="n">endpoint</span><span class="o">/</span><span class="n">mi</span><span class="o">/</span><span class="n">v1</span><span class="o">/</span><span class="p">:</span><span class="n">orgKey</span><span class="o">/</span><span class="n">time</span></code>
The response of this path is the the time value in plaintext.</p>
</blockquote>
<p>&nbsp;</p>
<blockquote>
<p><strong>WS</strong>: The <strong>time request</strong> message format is:</p>
<p><code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;req&quot;</span><span class="p">:</span><span class="ss">&quot;time&quot;</span><span class="err">}</span></code></p>
<p>The server will send a <strong>time response</strong> message to the Device. The format is:
<code class="codehilite"><span class="n">js</span><span class="err">{</span><span class="ss">&quot;res&quot;</span><span class="p">:</span><span class="ss">&quot;time&quot;</span><span class="p">,</span><span class="ss">&quot;data&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;ts&quot;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">time</span><span class="o">&gt;</span><span class="err">}</span><span class="err">}</span></code></p>
</blockquote>
</blockquote>
<h2 id="corebus">CoreBus</h2>
<p>coreBus module provides three main methods:</p>
<p><code class="codehilite"><span class="n">coreBus</span><span class="p">.</span><span class="k">on</span><span class="p">(</span><span class="n">eventName</span><span class="p">,</span> <span class="n">coreBusHandler</span><span class="p">)</span></code> where <code class="codehilite"><span class="n">coreBusHandler</span></code> has the signature <code class="codehilite"><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span></code></p>
<p><code class="codehilite"><span class="n">coreBus</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">eventName</span><span class="p">,</span> <span class="k">data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span></code></p>
<p><code class="codehilite"><span class="n">ctxReturn</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="k">data</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span></code></p>
<h2 id="bus-event-naming">Bus Event Naming</h2>
<p>Machine Interface, no matter it is via HTTP or WS, will reach the mi-* coreBus events.</p>
<h2 id="the-following-is-going-to-be-redesigned">The following is going to be redesigned.</h2>
<p><code class="codehilite"><span class="n">CoreEventBus</span></code> (EventEmitter) has the following setting:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;event&quot;</span><span class="o">:</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;database&quot;</span><span class="p">,</span>
  <span class="s2">&quot;handler&quot;</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">sql</span> <span class="o">=</span> <span class="sb">`INSERT INTO operations (server_ts, device_id, op_ip, op_ts, op_type) VALUES(?,?,?,?,?)`</span><span class="p">;</span>
    <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">sql</span><span class="p">,</span> <span class="p">[</span><span class="nx">serverTs</span><span class="p">,</span> <span class="nx">chipId</span><span class="p">,</span> <span class="nx">ip</span><span class="p">,</span> <span class="nx">ts</span><span class="p">,</span> <span class="nx">op_type</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;err on /record/0/..&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="nx">CoreEventBus</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;post-injection&#39;</span><span class="p">,{</span><span class="nx">error</span><span class="o">:</span><span class="nx">err</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`A row has been inserted with rowid </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lastID</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
      <span class="nx">dbUpdateOperationsByRowId</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lastID</span><span class="p">);</span>
      <span class="nx">CoreEventBus</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;post-injection&#39;</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<h2 id="general-operations">General Operations</h2>
<ul>
<li>Devices have to be registered in IoT Server before any communication.</li>
<li>Devices registration must be performed by a user account.</li>
<li>In Device Registration, a device is assigned to one Work Unit (machine or production line etc.) and one or more events to submit to the server.</li>
</ul>
<h2 id="device-start-up">Device start up</h2>
<ul>
<li>Device starts</li>
<li>Program loaded start to work recording events</li>
<li>If network is working, response server auth request.</li>
<li>If network is working and auth responded, if unsent messages exists then submit resend request</li>
<li>If network is working and auth responded, send directly events to server</li>
<li>Connecting to Wifi or internet</li>
</ul>
<h2 id="indexing-of-the-database">Indexing of the database</h2>
<p>I find indexing need with where clause analysis.</p>
<p>lib\util.js
  - function createSelectSQL 
    - any table <code class="codehilite"><span class="n">_id</span></code>
    - any table <code class="codehilite"><span class="n">orgs</span></code></p>
<p>lib\wss.js
  - function sql_selectOrgsByOrgKey
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">orgs</span> <span class="k">where</span> <span class="n">orgKey</span> <span class="o">=</span> <span class="o">?</span></code>
  - wss
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">devices</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span> <span class="k">and</span> <span class="n">token</span><span class="o">=?</span></code></p>
<p>.\routers\data-classes.js
  - coreBus.on('data-orgs-classes',(data,ctx,cb)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">classes</span> <span class="k">where</span> <span class="n">orgs</span><span class="o">=?</span></code> </p>
<p>./routers/data-devices.js
  - router.param('device_id',function(req,res,next,val){
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">devices</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code>
  - coreBus.on('data-orgs-device-update',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">devices</span> <span class="k">set</span> <span class="k">type</span><span class="o">=?</span><span class="p">,</span> <span class="k">usage</span><span class="o">=?</span><span class="p">,</span> <span class="n">description</span><span class="o">=?</span><span class="p">,</span> <span class="n">max_machine</span><span class="o">=?</span><span class="p">,</span> <span class="n">status</span><span class="o">=?</span><span class="p">,</span> <span class="n">who</span><span class="o">=?</span><span class="p">,</span><span class="n">ts</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
  - coreBus.on('data-orgs-device-new-token',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">devices</span> <span class="k">set</span> <span class="n">token</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span> <span class="n">tokenTs</span> <span class="o">=</span> <span class="o">?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code></p>
<p>./routers/data-logins.js
  - const sql_selectLoginsByUid = admin.prepare(
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">logins</span> <span class="k">where</span> <span class="n">uid</span><span class="o">=?</span></code></p>
<p>./routers/data-machines.js
  - router.param('device_id',function(req,res,next,val){
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">devices</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code>
  - coreBus.on('data-orgs-machines-current-status',(data,ctx,cb)=&gt;{
    - where op_ts &gt; strftime('%s','now') - ${s5m} -- within 5min
    - where op_ts &gt; strftime('%s','now') - ${s1h} -- within 1hr 
  - coreBus.on('data-orgs-machine-update',(data,ctx)=&gt;{
      - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">machines</span> <span class="k">set</span><span class="o">-</span> <span class="n">code</span> <span class="o">=?</span><span class="p">,</span> <span class="n">name</span> <span class="o">=?</span><span class="p">,</span> <span class="k">class</span> <span class="o">=?</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=?</span><span class="p">,</span> <span class="n">status</span> <span class="o">=?</span><span class="p">,</span> <span class="k">type</span> <span class="o">=?</span><span class="p">,</span> <span class="k">location</span> <span class="o">=?</span><span class="p">,</span> <span class="n">bound</span> <span class="o">=?</span><span class="p">,</span> <span class="n">cum_count</span><span class="o">=?</span><span class="p">,</span> <span class="n">wo</span><span class="o">=?</span><span class="p">,</span> <span class="n">product</span><span class="o">=?</span><span class="p">,</span> <span class="n">mold</span><span class="o">=?</span><span class="p">,</span> <span class="n">target</span><span class="o">=?</span><span class="p">,</span> <span class="n">who</span><span class="o">=?</span><span class="p">,</span> <span class="n">ts</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
  - coreBus.on('data-orgs-machine-work-status-update',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">machines</span> <span class="k">set</span> <span class="n">wo</span><span class="o">=?</span><span class="p">,</span> <span class="n">product</span><span class="o">=?</span><span class="p">,</span> <span class="n">mold</span><span class="o">=?</span><span class="p">,</span> <span class="n">target</span><span class="o">=?</span><span class="p">,</span> <span class="n">status</span><span class="o">=?</span><span class="p">,</span> <span class="n">who</span><span class="o">=?</span><span class="p">,</span> <span class="n">ts</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code></p>
<p>./routers/data-me.js
  - coreBus.on('data-me-update',(data,ctx)=&gt;{
    - let sql = 'update logins set name=?, mobile=?, tz=?, who=?, ts=? where _id=?'
  - coreBus.on('data-me-change-password',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">logins</span> <span class="k">set</span> <span class="n">pwd</span><span class="o">=?</span><span class="p">,</span> <span class="n">who</span><span class="o">=?</span><span class="p">,</span> <span class="n">ts</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
  - coreBus.on('data-me-orgs',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">roles</span> <span class="k">from</span> <span class="n">orgs</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">orgs_logins</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">orgs</span> <span class="k">where</span> <span class="n">b</span><span class="p">.</span><span class="n">logins</span> <span class="o">=?</span> <span class="p">;</span></code></p>
<p>./routers/data-orgs.js
  - coreBus.on('data-org-update',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">orgs</span> <span class="k">set</span> <span class="n">name</span><span class="o">=?</span><span class="p">,</span> <span class="n">sn</span><span class="o">=?</span><span class="p">,</span> <span class="n">tz</span><span class="o">=?</span><span class="p">,</span> <span class="n">who</span><span class="o">=?</span><span class="p">,</span> <span class="n">ts</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code>
    - const sql_updateOrgsOrgKeyById  = admin.prepare(
      - <code class="codehilite"><span class="k">update</span> <span class="n">orgs</span> <span class="k">set</span> <span class="n">orgKey</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span> <span class="n">orgKeyTs</span> <span class="o">=</span> <span class="o">?</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code></p>
<p>./routers/data-units.js
  - router.param('device_id',function(req,res,next,val){
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">devices</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span></code>
  - router.param('machine_id',(req,res,next,val)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">machines</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
  - coreBus.on('data-orgs-unit',(data,ctx)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">units</span> <span class="k">where</span> <span class="n">_id</span><span class="o">=?</span> <span class="k">and</span> <span class="n">orgs</span><span class="o">=?</span></code>
  - coreBus.on('data-orgs-units-of-device',(data,ctx,cb)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="n">uu</span><span class="p">.</span><span class="o">*</span> <span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="k">class</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">physical_id</span><span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="n">wo</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">product</span><span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="n">target</span><span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="n">mold</span><span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="n">code</span> <span class="k">as</span> <span class="n">machine$code</span> <span class="p">,</span><span class="n">m</span><span class="p">.</span><span class="k">type</span> <span class="k">as</span> <span class="n">machine$type</span><span class="k">from</span> <span class="n">units</span> <span class="n">u</span><span class="k">left</span> <span class="k">join</span> <span class="n">units</span> <span class="n">uu</span> <span class="k">on</span> <span class="n">u</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">uu</span><span class="p">.</span><span class="n">headers</span><span class="k">left</span> <span class="k">join</span> <span class="n">machines</span> <span class="n">m</span> <span class="k">on</span> <span class="n">uu</span><span class="p">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">_id</span><span class="k">left</span> <span class="k">join</span> <span class="n">devices</span> <span class="n">d</span> <span class="k">on</span> <span class="n">uu</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">_id</span><span class="k">where</span> <span class="n">u</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="o">?</span> <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">orgs</span><span class="o">=?</span></code>
  - coreBus.on('data-orgs-units-of-machine',(data,ctx,cb)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="n">uu</span><span class="p">.</span><span class="o">*</span> <span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="k">class</span><span class="p">,</span> <span class="n">d</span><span class="p">.</span><span class="n">physical_id</span><span class="k">from</span> <span class="n">units</span> <span class="n">u</span><span class="k">left</span> <span class="k">join</span> <span class="n">units</span> <span class="n">uu</span> <span class="k">on</span> <span class="n">u</span><span class="p">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">uu</span><span class="p">.</span><span class="n">headers</span><span class="k">left</span> <span class="k">join</span> <span class="n">machines</span> <span class="n">m</span> <span class="k">on</span> <span class="n">uu</span><span class="p">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">_id</span><span class="k">left</span> <span class="k">join</span> <span class="n">devices</span> <span class="n">d</span> <span class="k">on</span> <span class="n">uu</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">_id</span><span class="k">where</span> <span class="n">u</span><span class="p">.</span><span class="n">machines</span> <span class="o">=</span> <span class="o">?</span> <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">orgs</span><span class="o">=?</span></code>
  - coreBus.emit('data-orgs-units-of-machine',{id:data.machine},ctx,(er,unit1)=&gt;{
    - let sql2 = <code class="codehilite"><span class="k">update</span> <span class="n">units</span> <span class="k">set</span> <span class="n">devices</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span> <span class="n">op_type</span><span class="o">=?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
    - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">units</span> <span class="k">set</span> <span class="n">headers</span><span class="o">=?</span> <span class="k">where</span> <span class="n">headers</span><span class="o">=?</span></code></p>
<p>./routers/mi.js
  - coreBus.on('db-update-operations-by-row-id',(data,ctx,cb)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">v_operations</span> <span class="k">where</span> <span class="n">rowId</span><span class="o">=?</span></code>
  - coreBus.on('db-update-operations-by-row-id',(data,ctx,cb)=&gt;{
    - let sql2 = <code class="codehilite"><span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="ss">(</span><span class="nv">select</span> <span class="s1">&#39;</span><span class="s">prev</span><span class="s1">&#39;</span> [<span class="nv">rowType</span>], <span class="nv">rowId</span>, <span class="o">*</span> <span class="nv">from</span> <span class="nv">operations</span><span class="nv">where</span> <span class="nv">orgs</span> <span class="o">=</span> ? <span class="nv">and</span> <span class="nv">op_ts</span> <span class="o">&lt;</span> ? <span class="nv">and</span> <span class="nv">devices</span><span class="o">=</span>? <span class="nv">and</span> <span class="nv">op_type</span><span class="o">=</span>?<span class="nv">order</span> <span class="nv">by</span> <span class="nv">op_ts</span> <span class="nv">desc</span> <span class="nv">limit</span> <span class="mi">1</span><span class="ss">)</span> <span class="nv">union</span><span class="nv">select</span> <span class="o">*</span> <span class="nv">from</span> <span class="ss">(</span><span class="nv">select</span> <span class="s1">&#39;</span><span class="s">next</span><span class="s1">&#39;</span> [<span class="nv">rowType</span>], <span class="nv">rowId</span>, <span class="o">*</span> <span class="nv">from</span> <span class="nv">operations</span><span class="nv">where</span> <span class="nv">orgs</span> <span class="o">=</span> ? <span class="nv">and</span> <span class="nv">op_ts</span> <span class="o">&gt;</span> ? <span class="nv">and</span> <span class="nv">devices</span><span class="o">=</span>? <span class="nv">and</span> <span class="nv">op_type</span><span class="o">=</span>?<span class="nv">order</span> <span class="nv">by</span> <span class="nv">op_ts</span> <span class="nv">limit</span> <span class="mi">1</span><span class="ss">)</span></code>;
    - updatePrevSQL = <code class="codehilite">update operations set cycle_tm = <span class="cp">${</span><span class="n">thisRow</span><span class="o">.</span><span class="n">op_ts</span> <span class="o">-</span> <span class="n">prevRow</span><span class="o">.</span><span class="n">op_ts</span><span class="cp">}</span> where rowId=<span class="cp">${</span><span class="n">prevRow</span><span class="o">.</span><span class="n">rowId</span><span class="cp">}</span></code>
    - updateThisSQL = <code class="codehilite">update operations set <span class="cp">${</span><span class="n">setThisClause</span><span class="cp">}</span> where rowId=<span class="cp">${</span><span class="n">data</span><span class="o">.</span><span class="n">rowId</span><span class="cp">}</span></code>
  - coreBus.on('db-update-measures-by-row-id',(data,ctx,cb)=&gt;{
    - let sql = <code class="codehilite"><span class="k">select</span> <span class="n">mm</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="n">measures</span> <span class="n">m</span><span class="k">inner</span> <span class="k">join</span> <span class="n">units</span> <span class="n">u</span> <span class="k">on</span> <span class="n">m</span><span class="p">.</span><span class="n">orgs</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">orgs</span> <span class="k">and</span> <span class="n">m</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">devices</span> <span class="k">and</span> <span class="n">m</span><span class="p">.</span><span class="n">op_type</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">op_type</span><span class="k">left</span> <span class="k">join</span> <span class="n">machines</span> <span class="n">mm</span> <span class="k">on</span> <span class="n">u</span><span class="p">.</span><span class="n">orgs</span> <span class="o">=</span> <span class="n">mm</span><span class="p">.</span><span class="n">orgs</span> <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">mm</span><span class="p">.</span><span class="n">_id</span><span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">rowId</span> <span class="o">=</span> <span class="o">?</span></code>
  - function patchMachineInformation(rowId,tableName,fieldName,ctx){
    - let sql2 = <code class="codehilite">update <span class="cp">${</span><span class="n">tableName</span><span class="cp">}</span> set <span class="cp">${</span><span class="n">fieldName</span><span class="cp">}</span>=&#39;<span class="cp">${</span><span class="n">machine_id</span><span class="cp">}</span>&#39; where ROWID = <span class="cp">${</span><span class="n">rowId</span><span class="cp">}</span></code>;
  - const sql_selectOrgsByOrgKey = admin.prepare(
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">orgs</span> <span class="k">where</span> <span class="n">orgKey</span> <span class="o">=</span> <span class="o">?</span></code></p>
<p>./routers/pdata.js
  - coreBus.on('reset-password',(data,ctx,cb)=&gt;{
  - let sql = <code class="codehilite"><span class="k">update</span> <span class="n">logins</span> <span class="k">set</span> <span class="n">reset_pwd_token</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span><span class="n">reset_pwd_ts</span> <span class="o">=</span> <span class="o">?</span> <span class="k">where</span> <span class="n">_id</span> <span class="o">=</span> <span class="o">?</span></code>
  - sql_selectLoginsByUid = admin.prepare(
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">logins</span> <span class="k">where</span> <span class="n">uid</span><span class="o">=?</span></code>,
  - let sql_selectLoginsByEmail = admin.prepare(
    - <code class="codehilite"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">logins</span> <span class="k">where</span> <span class="n">email</span><span class="o">=?</span></code> )</p>
<h2 id="miot">mIoT</h2>
<p>This is about mobile app api design. The mIoT is mainly a on-site tool to work with QR Code labels sticked on devices, machines or location etc. The users don't need to go back to web portal on PCs to do some recording activities.</p>
<p>System should be able to manage the following activities:</p>
<ul>
<li>The number of mIoT mobiles connecting to the Server.</li>
<li>The number of operators using the mIoT.</li>
</ul>
<p>Design:</p>
<ul>
<li>mIoT can be used solely by a registered user of IoT.</li>
<li>mIoT can be used for operators of a specific org.</li>
<li>mIoT has a setup registration record in the App.</li>
</ul>
<p>mIoT for a registered user of IoT Server:</p>
<ul>
<li>the mIoT impersonates as the user</li>
</ul>
<p>mIoT for operators of an org:</p>
<ul>
<li>the mIoT is registered under an org, as an asset of the org.</li>
<li>the operation in the mIoT requires the operator to provide password to perform.</li>
</ul>
<p>Table design:</p>
<ul>
<li>Table: data.mobiles to keep the register mobile devices installed mIoT (fields "orgs" or "logins" to )</li>
<li>Table: data.operators to keep the operators list of an org.</li>
</ul>
<p>Registration data:</p>
<div class="codehilite"><pre><span></span><span class="nx">config</span><span class="o">:</span><span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span>
  <span class="nx">token</span><span class="o">:</span>
  <span class="nx">endpoint</span><span class="o">:</span>
  <span class="nx">protocol</span><span class="o">:</span>
  <span class="nx">ts</span><span class="o">:</span>
<span class="p">}</span>
<span class="nx">user</span><span class="o">:</span><span class="nx">logins</span><span class="p">.</span><span class="nx">_id</span>
<span class="nx">userSetting</span><span class="o">:</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
</pre></div>

<p>DI API:</p>
<p>/sign-in-miot/ {device_id,}</p>
<h2 id="bugs-todo">Bugs &amp; Todo</h2>
<p>The bugs are found here:</p>
<ul>
<li>Prepared Select statement return cached old result even after update of the data. Eg. <code class="codehilite"><span class="n">sql_selectLoginsByUid</span></code>.</li>
</ul>
<p>Todo are here:</p>
<ul>
<li>Indexing the database to improve the performance.</li>
<li>Moving of operation and measure records to some kind of log table.</li>
<li>Provide user interface for creating/editing machines, assignment of device to machines, work status of Machine.</li>
<li>Review the dashboard styling based on Samson's comment.</li>
<li>Complete the TOOLv1</li>
<li>OTA update of LFS library of devices.</li>
<li>3-Axis Algorithm to count the action of robot-arm.</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a8b5e56f.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>